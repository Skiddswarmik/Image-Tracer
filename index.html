<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Overlay Editor</title>

<style>
body, html {
  margin: 0;
  height: 100%;
  background: #000;
  overflow: hidden;
  font-family: Helvetica, Arial, sans-serif;
}

#container {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  touch-action: none;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.2s ease;
}

.flipped { transform: scaleX(-1); }

/* Overlay */
#overlay {
  position: absolute;
  border: 2px solid rgba(255,255,255,0.7);
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  display: none;
  touch-action: none;
  top: 50px;
  left: 50px;
  border-radius: 8px;
}

#overlayImg {
  width: 100%;
  height: 100%;
  pointer-events: none;
  border-radius: 6px;
}

/* Corner handles */
.overlay-handle {
  width: 14px;
  height: 14px;
  background: #fff;
  border: 2px solid #000;
  border-radius: 50%;
  position: absolute;
  z-index: 10;
}

.overlay-handle.tl { top: -9px; left: -9px; }
.overlay-handle.tr { top: -9px; right: -9px; }
.overlay-handle.bl { bottom: -9px; left: -9px; }
.overlay-handle.br { bottom: -9px; right: -9px; }

/* Control panel */
.control-panel {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  border-radius: 12px;
  color: #fff;
  z-index: 9999;
  font-size: 14px;
}

.panel-body {
  display: none;
  padding: 8px 12px;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}
</style>
</head>

<body>
<div id="container">
  <video id="camera" autoplay playsinline></video>

  <div id="overlay">
    <img id="overlayImg">
    <div class="overlay-handle tl"></div>
    <div class="overlay-handle tr"></div>
    <div class="overlay-handle bl"></div>
    <div class="overlay-handle br"></div>
  </div>
</div>

<!-- Camera Panel -->
<div class="control-panel" id="cameraPanel">
  <div class="panel-header">
    Camera Controls
    <span id="cameraToggle">▼</span>
  </div>
  <div class="panel-body" id="cameraBody">
    <label><input type="checkbox" id="flipCamera"> Flip Camera</label>
    <label><input type="checkbox" id="useRearCamera"> Use Rear Camera</label>
  </div>
</div>

<!-- Photo Panel -->
<div class="control-panel" id="photoPanel" style="bottom: 90px;">
  <div class="panel-header">
    Photo Editing
    <span id="photoToggle">▼</span>
  </div>
  <div class="panel-body" id="photoBody">
    <label style="cursor:pointer">
      Upload Image
      <input type="file" id="imageUpload" accept="image/*" style="display:none">
    </label>

    <label>Opacity <input type="range" id="opacitySlider" min="0" max="1" step="0.05" value="1"></label>
    <label><input type="checkbox" id="lockRatio" checked> Lock Ratio</label>
    <label><input type="checkbox" id="flipOverlay"> Flip Overlay</label>

    <label><input type="checkbox" id="removeColor"> Remove Color</label>
    <label>Key Color <input type="color" id="keyColor" value="#ffffff"></label>
    <label>Tolerance <input type="range" id="tolerance" min="0" max="100" value="20"></label>
  </div>
</div>

<script>
/************************************
  PANEL TOGGLE — starts CLOSED
*************************************/
function setupPanel(toggleId, bodyId) {
  const toggle = document.getElementById(toggleId);
  const body = document.getElementById(bodyId);
  toggle.addEventListener("click", () => {
    const open = body.style.display !== "flex";
    body.style.display = open ? "flex" : "none";
    toggle.textContent = open ? "▲" : "▼";
  });
}

setupPanel("cameraToggle", "cameraBody");
setupPanel("photoToggle", "photoBody");

/************************************
  ELEMENTS
*************************************/
const camera = document.getElementById("camera");
const overlay = document.getElementById("overlay");
const overlayImg = document.getElementById("overlayImg");
const imageUpload = document.getElementById("imageUpload");
const lockRatio = document.getElementById("lockRatio");
const opacitySlider = document.getElementById("opacitySlider");
const flipOverlay = document.getElementById("flipOverlay");
const useRearCamera = document.getElementById("useRearCamera");
const flipCamera = document.getElementById("flipCamera");
const removeColor = document.getElementById("removeColor");
const keyColorInput = document.getElementById("keyColor");
const toleranceInput = document.getElementById("tolerance");

/************************************
  CAMERA — FRONT/BACK SWITCH
*************************************/
let currentStream = null;

async function startCamera(useRear = false) {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
  }

  const constraints = {
    video: {
      facingMode: useRear ? { exact: "environment" } : "user"
    }
  };

  try {
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    camera.srcObject = currentStream;

    camera.classList.toggle("flipped", !useRear);

  } catch (err) {
    console.error("Camera error:", err);

    if (useRear) {
      console.warn("Rear camera not available, falling back.");
      useRearCamera.checked = false;
      startCamera(false);
    }
  }
}

startCamera(false);

useRearCamera.addEventListener("change", e => {
  startCamera(e.target.checked);
});

flipCamera.addEventListener("change", () => {
  camera.classList.toggle("flipped", flipCamera.checked);
});

/************************************
  OVERLAY TRANSFORM STATE
*************************************/
let isDragging = false;
let startX, startY, offsetX, offsetY;
let initialDistance = 0, initialAngle = 0;
let initialScale = 1, currentScale = 1;
let initialRotation = 0, currentRotation = 0;

/************************************
  TOUCH / GESTURE
*************************************/
overlay.addEventListener("touchstart", e => {
  e.preventDefault();

  if (e.touches.length === 1) {
    const t = e.touches[0];
    isDragging = true;
    startX = t.clientX;
    startY = t.clientY;
    offsetX = overlay.offsetLeft;
    offsetY = overlay.offsetTop;
  }

  if (e.touches.length === 2) {
    const [a, b] = e.touches;
    initialDistance = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
    initialAngle = Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX);
    initialScale = currentScale;
    initialRotation = currentRotation;
  }
});

overlay.addEventListener("touchmove", e => {
  e.preventDefault();

  if (e.touches.length === 1 && isDragging) {
    const t = e.touches[0];
    overlay.style.left = offsetX + (t.clientX - startX) + "px";
    overlay.style.top = offsetY + (t.clientY - startY) + "px";
  }

  if (e.touches.length === 2) {
    const [a, b] = e.touches;
    let dist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
    let angle = Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX);

    currentScale = initialScale * (dist / initialDistance);
    currentRotation = initialRotation + (angle - initialAngle) * 180 / Math.PI;

    updateTransform();
  }
});

overlay.addEventListener("touchend", () => {
  isDragging = false;
});

/************************************
  MOUSE WHEEL ROTATE/ZOOM
*************************************/
overlay.addEventListener("wheel", e => {
  e.preventDefault();
  if (e.shiftKey) currentRotation += e.deltaY < 0 ? 3 : -3;
  else currentScale += e.deltaY < 0 ? 0.05 : -0.05;
  updateTransform();
});

/************************************
  APPLY TRANSFORM
*************************************/
function updateTransform() {
  const flip = flipOverlay.checked ? -1 : 1;
  overlay.style.transform = `scale(${currentScale * flip}) rotate(${currentRotation}deg)`;
}

opacitySlider.addEventListener("input", () => overlay.style.opacity = opacitySlider.value);
flipOverlay.addEventListener("change", updateTransform);

/************************************
  IMAGE UPLOAD
*************************************/
imageUpload.addEventListener("change", e => {
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = evt => {
    overlayImg.src = evt.target.result;
    overlay.style.display = "block";
  };
  reader.readAsDataURL(file);
});

/************************************
  CHROMA KEY (COLOR REMOVAL)
*************************************/
const processingCanvas = document.createElement("canvas");
const processingCtx = processingCanvas.getContext("2d");

function applyChromaKey() {
  if (!removeColor.checked || !overlayImg.src) return;

  const img = overlayImg;

  processingCanvas.width = img.naturalWidth;
  processingCanvas.height = img.naturalHeight;

  processingCtx.drawImage(img, 0, 0);

  let imgData = processingCtx.getImageData(0, 0, img.naturalWidth, img.naturalHeight);
  let data = imgData.data;

  const keyHex = keyColorInput.value;
  const tolerance = parseInt(toleranceInput.value);

  const rKey = parseInt(keyHex.slice(1,3), 16);
  const gKey = parseInt(keyHex.slice(3,5), 16);
  const bKey = parseInt(keyHex.slice(5,7), 16);

  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i+1];
    const b = data[i+2];

    const diff = Math.sqrt(
      (r - rKey)**2 +
      (g - gKey)**2 +
      (b - bKey)**2
    );

    if (diff < tolerance * 3) {
      data[i+3] = 0;
    }
  }

  processingCtx.putImageData(imgData, 0, 0);
  overlayImg.src = processingCanvas.toDataURL();
}

removeColor.addEventListener("change", applyChromaKey);
keyColorInput.addEventListener("input", applyChromaKey);
toleranceInput.addEventListener("input", applyChromaKey);

overlayImg.onload = () => {
  if (removeColor.checked) applyChromaKey();
};
</script>
</body>
</html>
